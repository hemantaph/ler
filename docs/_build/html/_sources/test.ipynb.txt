{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "To calculate the optical depth for an Elliptical Power Law (EPL) lens model with external shear, we need to define the probability of strong lensing for this model and integrate it over the appropriate lens parameters and redshift. Here is how you could approach this calculation, building on the previous examples for SIS and SIE lenses:\n",
    "\n",
    "### Optical Depth for EPL+Shear Lens\n",
    "\n",
    "1. **Model Description:**\n",
    "   - The EPL model is characterized by a power-law mass distribution, which generalizes the SIE model by allowing for a varying density profile indexed by $\\gamma$.\n",
    "   - External shear ($\\gamma_1$, $\\gamma_2$) is added to the potential to account for the tidal influence of nearby structures.\n",
    "   - The ellipticity parameters ($e_1$, $e_2$) describe the ellipticity of the lens.\n",
    "\n",
    "2. **Lensing Probability $P(SL|z_s, z_l, \\theta_L)$:**\n",
    "   - In the context of the EPL+Shear model, $\\theta_L$ includes the velocity dispersion $\\sigma$, axis ratio $q$ (or equivalently ellipticity $e_1, e_2$), power-law slope $\\gamma$, and the external shear parameters $\\gamma_1, \\gamma_2$.\n",
    "   - The Einstein radius $\\theta_E$ for the EPL model depends on these parameters and can be expressed as a function of them, though the exact expression may require numerical solutions depending on the complexity.\n",
    "\n",
    "3. **Calculating the Cross Section $\\phi_{\\text{EPL+Shear}}$:**\n",
    "   - The cross-section for lensing can be approximated as $\\phi_{\\text{EPL+Shear}} = \\pi \\theta_E^2$, modified by terms that account for the effects of ellipticity and shear. The form of this function will depend on detailed modeling and potentially numerical simulations to capture the geometric and gravitational interactions accurately.\n",
    "\n",
    "4. **Optical Depth Calculation:**\n",
    "   - You need to integrate the probability of lensing over all possible lens parameters and redshifts, similar to equations for SIS and SIE:\n",
    "\n",
    "\\begin{equation}\n",
    "\\begin{split}\n",
    "P(SL|z_s) &= \\frac{1}{4\\pi} \\int^{z_s}_{z_l=0} \\int_{\\theta_L} P(SL|z_s, z_l, \\theta_L) \\frac{d^2N(z_l, \\theta_L)}{dV_c d\\theta_L} \\frac{dV_c}{dz_l} dz_l d\\theta_L \\\\\n",
    "&= \\frac{1}{4\\pi} \\int^{z_s}_{z_l=0} \\int_{\\theta_L} \\phi_{\\text{EPL+Shear}} \\frac{d^2N(z_l, \\theta_L)}{dV_c d\\theta_L} \\frac{dV_c}{dz_l} dz_l d\\theta_L,\n",
    "\\end{split}\n",
    "\\end{equation}\n",
    "\n",
    "   - where $\\theta_L$ spans $\\{\\sigma, q, e_1, e_2, \\gamma, \\gamma_1, \\gamma_2\\}$.\n",
    "   - The distribution $d^2N(z_l, \\theta_L)$ would have to be derived from observational data or theoretical models that provide the joint distribution of these lens parameters.\n",
    "\n",
    "5. **Challenges and Considerations:**\n",
    "   - Detailed numerical modeling might be necessary, especially for integrating over a high-dimensional parameter space including ellipticity, shear, and power-law slope.\n",
    "   - Empirical or semi-analytical methods to estimate $\\phi_{\\text{EPL+Shear}}$ can be crucial, particularly if simplifying assumptions (like small shear or nearly spherical lenses) do not hold.\n",
    "\n",
    "6. **Further Steps:**\n",
    "   - Implement numerical integration techniques, potentially using Monte Carlo methods or adaptive integration schemes.\n",
    "   - Consider dependencies and covariances between parameters like $\\sigma$ and $\\gamma$, or between ellipticity and shear, which might impact the density function $d^2N$.\n",
    "\n",
    "This approach provides a framework to begin tackling the problem, though the specifics would likely require substantial computational resources and expertise in numerical relativity and gravitational lensing."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Calculation of Optical Depth for the EPL+Shear Model\n",
    "\n",
    "## Overview\n",
    "This document outlines the methodology for calculating the optical depth of an Elliptical Power Law (EPL) lens model with external shear. The optical depth represents the probability of strong lensing events where a source at a given redshift is multiply imaged due to gravitational lensing.\n",
    "\n",
    "## Definitions\n",
    "- **Optical Depth ($\\tau$)**: The probability that a light ray from a distant source is strongly lensed as it travels to the observer.\n",
    "- **EPL+Shear Model Parameters**:\n",
    "  - $\\sigma$: Velocity dispersion of the lens.\n",
    "  - $q$: Axis ratio of the elliptical mass distribution.\n",
    "  - $e_1, e_2$: Components of the ellipticity.\n",
    "  - $\\gamma_1, \\gamma_2$: Components of external shear.\n",
    "  - $\\gamma$: Density profile slope of the power law mass distribution.\n",
    "\n",
    "## Lensing Probability\n",
    "For the EPL+Shear model, the lensing probability, $P(SL|z_s, z_l, \\theta_L)$, is derived from the caustic area induced by the lens parameters. The caustic area, $\\phi_{\\text{EPL+Shear}}$, is computed numerically given the complexity of the EPL+Shear potential.\n",
    "\n",
    "## Mathematical Formulation\n",
    "The optical depth is calculated by integrating the lensing probability over the parameter space of the lenses and their redshift distribution:\n",
    "\\begin{equation}\n",
    "P(SL|z_s) = \\frac{1}{4\\pi} \\int_{0}^{z_s} \\int_{\\theta_L} \\phi_{\\text{EPL+Shear}}(\\theta_L) \\frac{d^2N(z_l, \\theta_L)}{dV_c d\\theta_L} \\frac{dV_c}{dz_l} dz_l d\\theta_L\n",
    "\\end{equation}\n",
    "Where:\n",
    "- $\\phi_{\\text{EPL+Shear}}(\\theta_L)$: Represents the caustic area for the given lens parameters.\n",
    "- $d^2N(z_l, \\theta_L)/dV_c d\\theta_L$: Density of lenses per unit volume per unit parameter space.\n",
    "- $dV_c/dz_l$: Comoving volume element per unit redshift.\n",
    "\n",
    "## Numerical Implementation\n",
    "The numerical calculation is performed using the `lenstronomy` software package, which allows for the precise modeling of complex lens geometries and the computation of caustic structures.\n",
    "\n",
    "### Steps:\n",
    "1. **Parameter Sampling**: Sample the lens parameter space $(\\sigma, q, e_1, e_2, \\gamma, \\gamma_1, \\gamma_2)$ using a Monte Carlo approach or grid sampling.\n",
    "2. **Caustic Area Calculation**: For each set of parameters, calculate the caustic area using the ray-tracing module in `lenstronomy`.\n",
    "3. **Integration**: Integrate the results across the sampled parameter space and redshifts to compute the total optical depth.\n",
    "\n",
    "## References\n",
    "- Reference to foundational papers and texts that discuss the theory and numerical methods involved in gravitational lensing.\n",
    "- Link to the `lenstronomy` documentation for detailed usage and additional features related to lens modeling.\n",
    "\n",
    "## Conclusion\n",
    "The calculation of optical depth for the EPL+Shear model provides essential insights into the probability and characteristics of strong lensing events. This methodology supports a wide range of astrophysical studies, from cosmological parameter estimation to studies of dark matter distribution in galaxies.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "To calculate the optical depth for a lens model that includes an Elliptical Power-Law (EPL) mass profile with external shear, we need to consider the lens properties such as mass density spectral index, ellipticity, and external shear. Here's a formulation for the optical depth considering these parameters:\n",
    "\n",
    "### General Setup for EPL+Shear Lens Model\n",
    "\n",
    "Let's denote:\n",
    "- $\\sigma$ as the velocity dispersion.\n",
    "- $q$ as the axis ratio of the elliptical distribution.\n",
    "- $\\gamma$ as the mass density spectral index.\n",
    "- $(e_1, e_2)$ as the components of ellipticity.\n",
    "- $(\\gamma_1, \\gamma_2)$ as the components of external shear.\n",
    "\n",
    "For the EPL+Shear model, we will calculate $\\phi_{\\text{EPL+Shear}}$, the effective lensing cross-section (or caustic area) numerically for given parameters and will use it similarly to the $\\phi_{\\text{SIS}}$ and $\\phi_{\\text{SIE}}$ used in the SIS and SIE models respectively.\n",
    "\n",
    "### Optical Depth Calculation\n",
    "\n",
    "The optical depth calculation for the EPL+Shear lens model can be expressed as:\n",
    "\n",
    "\\[\n",
    "\\begin{equation}\n",
    "P(SL|z_s) = \\int_0^{z_s} \\Phi_{\\text{EPL+Shear}}(z_l) dz_l\n",
    "\\end{equation}\n",
    "\\]\n",
    "\n",
    "Where,\n",
    "\\[\n",
    "\\begin{equation}\n",
    "\\Phi_{\\text{EPL+Shear}}(z_l) = \\int \\frac{\\phi_{\\text{EPL+Shear}}}{4\\pi} n_o P(\\sigma, q, e_1, e_2, \\gamma_1, \\gamma_2, \\gamma | z_l) \\frac{dV_c}{dz_l} d\\sigma dq de_1 de_2 d\\gamma_1 d\\gamma_2 d\\gamma\n",
    "\\end{equation}\n",
    "\\]\n",
    "\n",
    "- $\\phi_{\\text{EPL+Shear}}$ is the caustic area for the EPL+Shear lens model parameters at $z_l$.\n",
    "- $P(\\sigma, q, e_1, e_2, \\gamma_1, \\gamma_2, \\gamma | z_l)$ is the joint probability density function of the lens parameters given the lens redshift, $z_l$.\n",
    "- $n_o$ is the number density of lenses.\n",
    "- $\\frac{dV_c}{dz_l}$ represents the comoving volume element per unit redshift at $z_l$.\n",
    "\n",
    "### Specific Considerations\n",
    "\n",
    "1. **Caustic Area Calculation**: The effective lensing cross-section, $\\phi_{\\text{EPL+Shear}}$, must be numerically calculated based on the parameters. This involves simulating the lensing effect given the ellipticity, shear, and power-law mass density profile to determine how much area in the source plane can be strongly lensed by typical configurations of the EPL+Shear model.\n",
    "\n",
    "2. **Parameter Distribution**: The distribution function, $P(\\sigma, q, e_1, e_2, \\gamma_1, \\gamma_2, \\gamma | z_l)$, must either be empirically derived from observational data or assumed based on theoretical models. This function describes how likely a particular set of lens parameters is, given a lens at redshift $z_l$.\n",
    "\n",
    "3. **Integration over Parameters**: The calculation requires integration over all possible values of the parameters $(\\sigma, q, e_1, e_2, \\gamma_1, \\gamma_2, \\gamma)$, which could be computationally intensive. Techniques such as Monte Carlo integration might be useful here.\n",
    "\n",
    "This setup gives you a framework to calculate the optical depth for the EPL+Shear model by numerically determining the lensing cross-section for a range of lens parameters and integrating over the probable distribution of those parameters across different lens redshifts."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "language_info": {
   "name": "python"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
